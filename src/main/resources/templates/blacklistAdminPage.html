<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>CACAMUCA</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
  <th:block th:insert="~{common/adminHeader}" />
  <th:block th:insert="~{common/adminAside}" />
  <main class="p-4 sm:ml-64">
    <div class="relative overflow-x-auto shadow-md sm:rounded-lg m-10">
      <table id="blackListTable" class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
          <tr>
            <th scope="col" class="px-6 py-3">블랙리스트 번호</th>
            <th scope="col" class="px-6 py-3">회원 번호</th>
            <th scope="col" class="px-6 py-3">회원 아이디</th>
            <th scope="col" class="px-6 py-3">등록일</th>
            <th scope="col" class="px-6 py-3">해제일</th>
            <th scope="col" class="px-6 py-3">블랙리스트 해제</th>
          </tr>
        </thead>

        <tbody>
          <tr th:each="blackList, blackListStat : ${blackListPage}" th:id="${blackListStat.index}">
            <th scope="row" class="px-6 py-4" th:text="${blackList.blackListNo}"></th>
            <th scope="row" class="px-6 py-4" th:text="${blackList.memberNo}"></th>
            <th scope="row" class="px-6 py-4" th:text="${blackList.memberId}"></th>
            <th scope="row" class="px-6 py-4" th:text="${blackList.blackListRegDate}"></th>
            <th scope="row" class="px-6 py-4" th:text="${blackList.blackListRelDate}"></th>
            <th scope="row">
              <button type="button" th:if="${blackList.getBlackListRelDate() == null}" onclick="releaseBlackList(event, true)" th:data-blacklist-id="${blackListStat.index}" class="py-2.5 px-5 mr-2 mb-2 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">차단 해제하기</button>
            </th>
          </tr>
        </tbody>
      </table>
    </div>

    <nav class="flex items-center justify-between pt-4" aria-label="Table navigation" >
            <span class="text-sm font-normal text-gray-500 dark:text-gray-400 ml-10 mb-15">Showing
                <span class="font-semibold text-gray-900 dark:text-white" th:text="${ blackListPage.getPageable().getOffset() } + 1" /> -
                <span class="font-semibold text-gray-900 dark:text-white" th:text="${ blackListPage.getPageable().offset } + ${ blackListPage.getNumberOfElements() }" /> of
                <span class="font-semibold text-gray-900 dark:text-white" th:text="${ blackListPage.getTotalElements() }" />
            </span>
      <ul class="inline-flex -space-x-px text-sm h-8">
        <li>
          <a id="previousButton" href="" class="flex items-center justify-center px-3 h-8 ml-0 leading-tight text-gray-500 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">Previous</a>
        </li>
        <li>
          <a id="page1Button" href="" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">
            <span th:if="${(blackListPage.getPageable().pageNumber < 6 && blackListPage.getTotalPages() < 6) || blackListPage.getPageable().pageNumber < 3}" th:text="1" ></span>
            <span th:if="${blackListPage.getPageable().pageNumber > blackListPage.getTotalPages() -  3 && blackListPage.getTotalPages() > 4}" th:text="${blackListPage.getTotalPages() - 4}"></span>
            <span th:if="${blackListPage.getPageable().pageNumber >= 3 && blackListPage.getPageable().pageNumber <= blackListPage.getTotalPages() - 3}" th:text="${blackListPage.getNumber()} - 1" ></span>
          </a>
        </li>
        <li>
          <a id="page2Button" href="" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">
            <span th:if="${blackListPage.getPageable().pageNumber < 6 && blackListPage.getTotalPages() < 6 || blackListPage.getPageable().pageNumber < 3}" th:text="2" ></span>
            <span th:if="${blackListPage.getPageable().pageNumber > blackListPage.getTotalPages() - 3 && blackListPage.getTotalPages() > 4}" th:text="${blackListPage.getTotalPages() - 3}"></span>
            <span th:if="${blackListPage.getPageable().pageNumber >= 3 && blackListPage.getPageable().pageNumber <= blackListPage.getTotalPages() - 3}" th:text="${blackListPage.getNumber()}" ></span>
          </a>
        </li>
        <li>
          <a id="page3Button" href="" aria-current="page"  class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">
            <span th:if="${blackListPage.getPageable().pageNumber < 6 && blackListPage.getTotalPages() < 6 || blackListPage.getPageable().pageNumber < 3}" th:text="3" ></span>
            <span th:if="${blackListPage.getPageable().pageNumber > blackListPage.getTotalPages() - 3 && blackListPage.getTotalPages() > 4}" th:text="${blackListPage.getTotalPages() - 2}"></span>
            <span th:if="${blackListPage.getPageable().pageNumber >= 3 && blackListPage.getPageable().pageNumber <= blackListPage.getTotalPages() - 3}" th:text="${blackListPage.getNumber()} + 1" ></span>
          </a>
        </li>
        <li>
          <a id="page4Button" href="" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">
            <span th:if="${blackListPage.getPageable().pageNumber < 6 && blackListPage.getTotalPages() < 6 || blackListPage.getPageable().pageNumber < 3}" th:text="4" ></span>
            <span th:if="${blackListPage.getPageable().pageNumber > blackListPage.getTotalPages() - 3 && blackListPage.getTotalPages() > 4}" th:text="${blackListPage.getTotalPages() - 1}"></span>
            <span th:if="${blackListPage.getPageable().pageNumber >= 3 && blackListPage.getPageable().pageNumber <= blackListPage.getTotalPages() - 3}" th:text="${blackListPage.getNumber()} + 2" ></span>
          </a>
        </li>
        <li>
          <a id="page5Button" href="" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">
            <span th:if="${blackListPage.getPageable().pageNumber < 6 && blackListPage.getTotalPages() < 6 || blackListPage.getPageable().pageNumber < 3}" th:text="5" ></span>
            <span th:if="${blackListPage.getPageable().pageNumber > blackListPage.getTotalPages() - 3 && blackListPage.getTotalPages() > 4}" th:text="${blackListPage.getTotalPages()}"></span>
            <span th:if="${blackListPage.getPageable().pageNumber >= 3 && blackListPage.getPageable().pageNumber <= blackListPage.getTotalPages() - 3}" th:text="${blackListPage.getNumber()} + 3" ></span>
          </a>
        </li>
        <li>
          <a id="nextButton" href="" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 rounded-r-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">Next</a>
        </li>
      </ul>
      <span class="text-sm font-normal text-gray-500 dark:text-gray-400 mr-10"> total pages :
                <span class="font-semibold text-gray-900 dark:text-white" th:text="${ blackListPage.getTotalPages()}" id="totalPages"/>
      </span>
    </nav>
  </main>

  <script>
    function releaseBlackList(event){
      const blacklistRowId = event.target.getAttribute('data-blacklist-id');
      const blacklistTable = document.getElementById(blacklistRowId);

      const blackListNo = blacklistTable.cells[0].innerText;
      const memberNo = blacklistTable.cells[1].innerText;
      const memberId = blacklistTable.cells[2].innerText;

      const data = {
        blackListNo: blackListNo,
        memberNo: memberNo,
        memberId: memberId,
      };

      axios.post('/admin-page/blacklist-release', data)
              .then(response => {
                console.log('Report deleted successfully:', response.data);
                window.location.reload();
              })
              .catch(error => {
                console.error('Error:', error);
              });
    }

    const urlParams = new URLSearchParams(window.location.search);
    const currentPage = parseInt(urlParams.get('page') || 0);

    const totalPages = document.getElementById('totalPages');
    const nextButton = document.getElementById('nextButton');
    const totalPagesInt = parseInt(totalPages.innerText) - 1;
    const nextPage = (currentPage === totalPagesInt) ? currentPage : currentPage + 1;
    nextButton.href = `/admin-page/blacklist?page=${nextPage}`;

    const previousButton = document.getElementById('previousButton');
    const previousPage = (currentPage === 0) ? currentPage : currentPage - 1;
    previousButton.href = `/admin-page/blacklist?page=${previousPage}`;

    let firstNum;
    if (currentPage > 2 && currentPage < totalPagesInt - 2)
      firstNum = currentPage - 2;
    else if (currentPage >= totalPagesInt - 2)
      firstNum = totalPagesInt - 4;
    else
      firstNum = 0;

    const page1Button = document.getElementById('page1Button');
    const page2Button = document.getElementById('page2Button');
    const page3Button = document.getElementById('page3Button');
    const page4Button = document.getElementById('page4Button');
    const page5Button = document.getElementById('page5Button');

    let button1Int = parseInt(page1Button.innerText);
    let button2Int = parseInt(page2Button.innerText);
    let button3Int = parseInt(page3Button.innerText);
    let button4Int = parseInt(page4Button.innerText);
    let button5Int = parseInt(page5Button.innerText);

    page1Button.href = `/admin-page/blacklist?page=${button1Int - 1}`;
    page2Button.href = `/admin-page/blacklist?page=${button2Int - 1}`;
    page3Button.href = `/admin-page/blacklist?page=${button3Int - 1}`;
    page4Button.href = `/admin-page/blacklist?page=${button4Int - 1}`;
    page5Button.href = `/admin-page/blacklist?page=${button5Int - 1}`;

    if (totalPagesInt === 0) {
      page2Button.style.display = 'none';
      page3Button.style.display = 'none';
      page4Button.style.display = 'none';
      page5Button.style.display = 'none';
    }
    else if (totalPagesInt === 1) {
      page3Button.style.display = 'none';
      page4Button.style.display = 'none';
      page5Button.style.display = 'none';
    }
    else if (totalPagesInt === 2) {
      page4Button.style.display = 'none';
      page5Button.style.display = 'none';
    }
    else if (totalPagesInt === 3) {
      page5Button.style.display = 'none';
    }

    switch (currentPage) {
      case button1Int - 1 :
        page1Button.style.backgroundColor = "#C3DDFD";
        break;
      case button2Int - 1 :
        page2Button.style.backgroundColor = '#C3DDFD';
        break;
      case button3Int - 1 :
        page3Button.style.backgroundColor = '#C3DDFD';
        break;
      case button4Int - 1 :
        page4Button.style.backgroundColor = '#C3DDFD';
        break;
      case button5Int - 1 :
        page5Button.style.backgroundColor = '#C3DDFD';
        break;
    }
  </script>
</body>
</html>